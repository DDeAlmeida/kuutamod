From 7e2c3b7c01b069f651a5dea9d27cee5f2dbf32ac Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?J=C3=B6rg=20Thalheim?= <joerg@thalheim.io>
Date: Fri, 6 May 2022 12:45:00 +0000
Subject: [PATCH] relax ulimit check for nix sandbox build
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

On nixos the nix-daemon limits files to 4096 by default...
In our tests we probably don't need more than that...

Signed-off-by: JÃ¶rg Thalheim <joerg@thalheim.io>
---
 core/store/src/db.rs | 16 +++++++++-------
 1 file changed, 9 insertions(+), 7 deletions(-)

diff --git a/core/store/src/db.rs b/core/store/src/db.rs
index 567a8a09c..b9865d2bb 100644
--- a/core/store/src/db.rs
+++ b/core/store/src/db.rs
@@ -149,13 +149,15 @@ fn ensure_max_open_files_limit(max_open_files: i32) -> () {
     let (soft, hard) = rlimit::Resource::NOFILE.get().unwrap();
     let required = max_open_files as u64 + 1025;
     if soft < required {
-        assert!(
-            hard >= required,
-            "Can't run near binary since hard limit for the number \
-                of opened files is too small: {} required: {}",
-            hard,
-            required
-        );
+        if hard < required {
+            warn!(
+                "Cannot increase hard limit limit for the number \
+                 of opened files current: {} required: {}",
+                hard,
+                required
+            );
+            return;
+        }
         rlimit::Resource::NOFILE.set(required, hard).unwrap();
     }
 }
-- 
2.35.3

